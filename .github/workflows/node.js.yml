name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test_backend:

    runs-on: ubuntu-latest

    steps:
    - name: Use Node.js 20.3.1
      uses: actions/setup-node@v2
      with:
         node-version: 16.14.0
         cache: "npm"
         cache-dependency-path: package-lock.json
    - name: Install Dependencies
      working-directory: ./server
      run: npm i
    - name: Run Tests
      working-directory: ./server
      run: npm test

  build_frontend:

    runs-on: ubuntu-latest

    steps:
    - name: Use Node.js 20.3.1
      uses: actions/setup-node@v3
      with:
        node-version: 20.3.1
        cache: 'npm'
        cache-dependency-path: package-lock.json
    - name: Install Dependencies
      working-directory: ./my-app
      run: npm i
    - name: Build Project
      working-directory: ./my-app
      run: npm run build --if-present

# Stop the workflow if the "test_folder_1" job fails
  fail-on-test-failure:
    needs: test_backend
    if: ${{ needs.test_backend.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
    - name: Fail the workflow
      run: exit 1
